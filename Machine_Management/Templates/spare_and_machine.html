<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Spare Part & Machine</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pridi&display=swap" rel="stylesheet">
    <script src='https://kit.fontawesome.com/a076d05399.js'></script>

    {% load static %}
    <!-- Jquery   -->
    <script src="{% static 'javascript/jquery-3.5.1.min.js' %}"></script>
    <!-- Bootstrap 4.5.3 -->
    <link rel="stylesheet" type="text/css" href="{% static 'style/bootstrap.min.css' %}">
    <script src="{% static 'javascript/bootstrap.min.js' %}"></script>
    <!--  Popper  -->
    <script src="{% static 'javascript/popper.min.js' %}"></script>
    <!-- DataTable   -->
    <link rel="stylesheet" type="text/css" href="{% static 'style/jquery.dataTables-1.10.19.min.css' %}">
    <script src="{% static 'javascript/jquery.dataTables.min.js' %}"></script>
    <!--  Container Form -->
    <link rel="stylesheet" type="text/css" href="{% static 'style/container-fluid.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'style/form-group.css' %}">

</head>
<body>
<div class="container-fluid">
    <nav class="navbar navbar-expand-md navbar-light" style="background-color: #f5f5f5;">
        <a href="{% url 'home' %}" class="navbar-brand">
            <img src="/static/img/farmhouse_logo copy.gif" height="65" alt="CoolBrand">
        </a>
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
            <div class="navbar-nav">
                <a href="{% url 'spare_part_manage' %}" class="nav-item nav-link">Spare Part</a>
                <a href="{% url 'spare_part_group' %}" class="nav-item nav-link ">Spare Part Group</a>
                <a href="{% url 'spare_part_type' %}" class="nav-item nav-link">Spare Part Type</a>
                <a href="{% url 'spare_part_subtype' %}" class="nav-item nav-link">Spare Part Subtype</a>
                <a href="{% url 'spare_part_and_machine' %}" class="nav-item nav-link active"><b>Spare part & Machine</b></a>
            </div>
            <form method="POST" action="{% url 'signin' %}">
                {% csrf_token %}
                <ul class="nav navbar-nav ml-auto">
                    <a href="#" class="nav-item nav-link" style="color:#B22222">{{User_login.username}}</a>
                    <button type="submit" class="btn btn-outline-secondary" name="signout">Sign out</button>
                </ul>
            </form>
        </div>
    </nav>
</div>
<div class="container-fluid">
    <div class="table-responsive">
        {% for message in messages %}
        <div class="alert {{ message.tags }} ">
            <span class="closebtn" onclick="this.parentElement.style.display='none';" style="color: #454545; font-size: 36px;">&times;</span>
            {{ message }}
        </div>
        {% endfor %}
        <div class="table-wrapper">
            <div class="table-title">
                <div class="row">
                    <div class="col-sm-5">
                        <h2>Spare Part & Machine <b>Management</b></h2>
                    </div>
                </div>
            </div>
            <table class="table table-striped" id="myTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Spare Part Group</th>
                        <th>Spare Part Type</th>
                        <th>Spare Part Name</th>
                        <th>Machine</th>
                        <th>Line</th>
                        <th {% if role_and_screen.0.permission_update == 'N' %}hidden{% endif %}>Action</th>
                    </tr>
                </thead>
                <tbody>
            {% for spare_part,machine_of_spare_part in dict_mch_sp.items %}
                <tr>
                    <td rowspan="{{machine_of_spare_part|length|add:1}}">{{forloop.counter}}</td>
                    <td rowspan="{{machine_of_spare_part|length|add:1}}">{{spare_part.spare_part_group}}</td>
                    <td rowspan="{{machine_of_spare_part|length|add:1}}">{{spare_part.spare_part_type}}</td>
                    <td rowspan="{{machine_of_spare_part|length|add:1}}">{{spare_part.spare_part_name}}</td>
                    {% if machine_of_spare_part %}
                    <td>{{machine_of_spare_part.0.machine_production_line_code}} | {{machine_of_spare_part.0.machine_name}}</td>
                    <td>{{machine_of_spare_part.0.line}}</td>
                    {% else %}
                    <td></td>
                    <td></td>
                    {% endif %}
                    <td rowspan="{{machine_of_spare_part|length|add:1}}" {% if role_and_screen.0.permission_update == 'N' %}hidden{% endif %}>
                        <a href="#setting{{forloop.counter}}" class="settings" title="Settings" data-toggle="modal"><i class="material-icons">add_circle</i></a>
                        <a href="#delete{{forloop.counter}}" class="delete" title="Delete" data-toggle="modal"><i class="material-icons">&#xE5C9;</i></a>
                    </td>
                </tr>
                {% for machine in machine_of_spare_part %}
                <tr>
                    {% if machine != machine_of_spare_part.0 %}
                    <td>{{machine.machine_production_line_code}} | {{machine.machine_name}}</td>
                    <td>{{machine.line}}</td>
                    {% endif %}
                </tr>
                {% endfor %}


            <!-- Modal Setting -->
            <div id="setting{{forloop.counter}}" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form method="POST" id="add_sp{{forloop.counter}}" data-sp-type-url="{% url 'ajax_spare_part_subtype' %}" data-sp-subtype-url="{% url 'load_spare_part' %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title">Setting</h5>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body" >
                                <div class="form-group">
                                    <label>Spare Part</label>
                                    <input type="text" id="set_spare_part{{forloop.counter}}" class="form-control" value="{{spare_part.spare_part_type}} | {{spare_part.spare_part_name}}" name="set_spare_part" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Select Production Line</label>
                                    <select class="form-control" id="select_line{{forloop.counter}}" name="select_line" onchange="machine(this)">
                                        <option value="0">-------กรุณาเลือกไลน์ผลิต-------</option>
                                        {% for line in user_org %}
                                        <option value="{{line.pk}}">{{line}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Select Machine Type</label>
                                    <select class="form-control" id="select_mch_type{{forloop.counter}}" name="select_mch_type" onchange="machine_type(this)">
                                        <option value="0">-------กรุณาเลือกประเภทของเครื่องจักร-------</option>
                                        {% for machine_type in machine_type_all %}
                                        <option value="{{machine_type.pk}}">{{machine_type.mtype_code}} | {{machine_type.mtype_name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Select Machine Subtype</label>
                                    <select class="form-control" id="select_mch_subtype{{forloop.counter}}" name="select_mch_subtype" onchange="machine(this)">
                                        <option value="0">-------กรุณาเลือกชนิดของเครื่องจักร-------</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Select Machine</label>
                                    <select class="form-control" id="select_mch{{forloop.counter}}" name="select_mch" onchange="machine_check(this)">
                                        <option value="">-------กรุณาเลือกเครื่องจักร-------</option>
                                    </select>
                                    <p><small style="visibility: visible; color: gray">#หากอะไหล่นั้นมีเครื่องจักรที่ต้องการจะเลือกแล้ว จะไม่มีชื่อเครื่องจักรนั้นให้เลือกอีก</small></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="add_sp_and_mch{{forloop.counter}}" name="add_sp_and_mch" value="{{spare_part.pk}}" {% if machine_of_spare_part|length == spare_part_all|length %} disabled {% endif %}>Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Modal Delete -->
            <div id="delete{{forloop.counter}}" class="modal fade" tabindex="-1" >
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form method="POST">
                            {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmation</h5>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Spare Part</label>
                                <input type="text" id="del_spare_part{{forloop.counter}}" class="form-control" value="Spare Part Name >>> {{spare_part.spare_part_sub_type}} | {{spare_part.spare_part_name}}" name="del_spare_part" readonly>
                            </div>
                            <div class="form-group">
                                <label>Select Spare Part</label>
                                <select class="form-control" id="select_delete_spare_part{{forloop.counter}}" name="select_delete_machine">
                                    {% for machine in machine_of_spare_part %}
                                    <option value="{{machine.pk}}"> {{machine.machine_production_line_code}} | {{machine.machine_name}} </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <p>Do you want to delete this machine of spare part?</p>
                                <p class="text-secondary"><small style="visibility: visible; color: gray">If you change your mind, please click cancel.</small></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger" value="{{spare_part.pk}}" name="delete_machine">Delete</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
</div>
<!--<script>-->
<!--    $(document).ready( function () {-->
<!--    $('#myTable').DataTable();-->
<!--} );-->
<!--</script>-->
<script>
        $(document).ready(function(){
            $("#setting").on("show.bs.modal", function(event){
                // Get the button that triggered the modal
                var button = $(event.relatedTarget);

                // Extract value from the custom data-* attribute
                var titleData = button.data("title");
                $(this).find(".modal-title").text(titleData);
            });
        });
    </script>
<script>
        $(document).ready(function(){
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
<script>
    function machine_type(element) {
        const mch_typeID = $(element).val();  // get the selected country ID from the HTML input
        var numID = element.id.substring(15);
        $.ajax({                       // initialize an AJAX request
            url: "{% url 'ajax_machine_subtype' %}",                    // set the url of the request (= /persons/ajax/load-cities/ )
            data: {
                'mch_type': mch_typeID       // add the country id to the GET parameters
            },
            success: function (data) {   // `data` is the return of the `load_cities` view function
                $("#select_mch_subtype"+numID).html(data);  // replace the contents of the city input with the data that came from the server
            }
        });
    };
</script>
<script>
    function machine(element) {
        const mch_typeID = $(element).val();
        if (element.id.substring(0,11) == "select_line" ) {
            var numID = element.id.substring(11);
        } else {
            var numID = element.id.substring(18);
        }
        var lineID = $("#select_line"+numID).val();
        var subtypeID = $("#select_mch_subtype"+numID).val();
        var spID = $("#add_sp_and_mch"+numID).val();
        if (lineID != 0  && subtypeID !=0) {
            $.ajax({
                url: "{% url 'load_machine' %}",
                data: {
                    'lineID': lineID,
                    'subtypeID': subtypeID,
                    'spID': spID
                },
                method: "POST",
                success: function (data) {
                    if (data) {
                        $('#select_mch'+numID).empty();
                        var select_mch = document.getElementById('select_mch'+numID);
                        var option_first = document.createElement('option');
                        option_first.appendChild(document.createTextNode("---------กรุณาเลือกเครื่องจักร---------"));
                        option_first.value = 0;
                        select_mch.appendChild(option_first);
                        for (model in data) {
                            var options = document.createElement('option');
                            options.appendChild(document.createTextNode(data[model].fields.machine_production_line_code+" | "+ data[model].fields.machine_name));
                            options.value = data[model].pk;
                            select_mch.appendChild(options);
                        }
                    } else {
                        $('#select_mch'+numID).empty();
                    }
                }
            });
        };
    };
</script>
<script>
    function machine_check(element) {
        var numID = element.id.substring(10);
        var button = document.getElementById('add_sp_and_mch'+numID);
        if (element.value != 0) {
            button.disabled = false;
        } else {
            button.disabled = true;
        }

    }
</script>
</body>
</html>
