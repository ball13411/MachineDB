{% extends "layout_maintenance_for_engineer.html" %}

{% block title %}Maintenance Management{% endblock %}

{% block static_and_style %}
    {% load static %}
{% endblock %}


{% block navbar %}
    <a href="{% url 'maintenance_data' %}" class="nav-item nav-link">Maintenance Status</a>
    <a href="{% url 'maintenance_plan_list' %}" class="nav-item nav-link active"><b>Maintenance Plan</b></a>
{% endblock %}


{% block content %}
    <div class="table-wrapper">
        <div class="table-title">
            <div class="row">
                <div class="col-sm-5">
                    <h2>Maintenance <b>Plan</b></h2>
                </div>
                
                <div class="col-sm-7">
                    <a href="#unacceptedMR" class="btn btn-secondary request-notify" data-toggle="modal">ใบแจ้งซ่อม <span class="badge maintenance-request-badge">{{ repair_receive_all.count }}</span></a>
                    <a href="{% url 'maintenance_plan_list' %}" class="list-view btn btn-link"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-list" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M2.5 11.5A.5.5 0 0 1 3 11h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 7h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 3h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg></a>
                    <a href="{% url 'maintenance_plan_grid' %}" class="grid-view btn btn-link active"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-grid-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/>
                        </svg></a>
                </div>
            </div>
        </div>
        <div class="jobs-status">
            <div class="row">
                <div class="col-lg-4 px-3">
                    <span class="h5">New Jobs</span>
                    <div class="scroll-area" data-spy="scroll" data-offset="0">

                        <!-- For loop maintenance requests -->
                        {% for repair in repair_receive_all %}
                            <div class="card">
                                <div class="card-hearder request-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-2"><b>{{repair.repair_no}}</b></h6>
                                        </div>
                                        <div class="text-right">
                                            <i class="fas fa-ellipsis-h" data-toggle="modal" data-target="#request-setting{{forloop.counter}}"></i>
                                        </div>
                                </div>
                                <div class="card-body request">
                                    <span class="badge request-badge">ใบแจ้งซ่อม</span>
                                    <p class="text-sm text-muted">{{repair.machine.machine_name}}  {{repair.machine.line}}</p>
                                    <span>
                                        <i class="far fa-clock"></i> DUE DATE : {{repair.use_date}}
                                    </span>
                                </div>
                            </div>
                            <!-- Modal maintenance requests -->
                            <div id="request-setting{{forloop.counter}}" class="modal fade" tabindex="-1">
                                <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <form method="POST">
                                            {% csrf_token %}
                                            <div class="modal-header">
                                                <h5 class="modal-title">ใบแจ้งซ่อมเครื่องจักร {{forloop.counter}}</h5>
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <h5><u><strong>ข้อมูลใบแจ้งซ่อม</strong></u></h5>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <label class="control-label">หมายเลขใบแจ้งซ่อม : {{repair.repair_no}}</label>
                                                        </div>
                                                        <div class="col-md-6" style="text-align: right;">
                                                            <label class="control-label">วันที่แจ้งซ่อม : {{repair.notification_date}}</label>
                                                        </div>
                                                    </div>
                                                <label class="control-label">สถานะใบแจ้งซ่อม : <b><u>{{repair.repair_status}}</u></b></label><br>
                                                <label class="control-label">หน่วยงานทีแจ้งใบแจ้งซ่อมเครื่องจักร : {{repair.department_notifying.department_code}} {{repair.department_notifying.department_name}}</label><br>
                                                <label class="control-label">หน่วยงานทีรับใบแจ้งซ่อมเครื่องจักร : {{repair.department_receive.department_code}} {{repair.department_receive.department_name}}</label><br>
                                                <div class="row">
                                                    <div class="col-2">
                                                        <label class="control-label">พนักงานที่แจ้ง :</label><br>
                                                        <label class="control-label">พนักงานที่ตรวจสอบ :</label><br>
                                                        <label class="control-label">พนักงานที่อนุมัติ :</label><br>
                                                    </div>
                                                    <div class="col-1">
                                                        <label class="control-label">{{repair.repairer_user.username}}</label><br>
                                                        <label class="control-label">{{repair.inspect_user.username}}</label><br>
                                                        <label class="control-label">{{repair.approve_user.username}}</label><br>
                                                    </div>
                                                    <div class="col-2">
                                                        <label class="control-label">{{repair.repairer_user.firstname}}  {{repair.repairer_user.lastname}}</label><br>
                                                        <label class="control-label">{{repair.inspect_user.firstname}}  {{repair.repairer_user.lastname}}</label><br>
                                                        <label class="control-label">{{repair.approve_user.firstname}}  {{repair.repairer_user.lastname}}</label><br>
                                                    </div>
                                                    <div class="col-4">
                                                        <label class="control-label">ที่อยู่อีเมล : {{repair.repairer_user.email}}</label><br>
                                                        <label class="control-label">ที่อยู่อีเมล : {{repair.inspect_user.email}}</label><br>
                                                        <label class="control-label">ที่อยู่อีเมล : {{repair.approve_user.email}}</label><br>
                                                    </div>
                                                </div>
                                                <hr>
                                                <h5><u><strong>เครื่องจักร</strong></u></h5>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="control-label">เครื่องจักร : <u>{{repair.machine.machine_production_line_code}} | {{repair.machine.machine_name}}</u>&nbsp;&nbsp;&nbsp; [ {{repair.machine.line}} ]</label><br>
                                                    </div>
                                                    <div class="col-md-6" style="float: right;">
                                                        <label class="control-label">วันที่ต้องการใช้งาน : {{repair.use_date}}</label><br>
                                                    </div>
                                                </div>
                                                <label class="control-label">ปัญหาเครื่องจักรที่พบ : {{repair.problem_report}}</label><br>
                                                <label class="control-label">ผลกระทบของปัญหา : {{repair.effect_problem}}</label><br>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-sm-8">
                                                        <h5><u><strong>อุปกรณ์หรือชิ้นส่วนที่ชำรุด</strong></u><a onclick="morePart(this)" id="more-part{{forloop.counter}}" type="button"><i class="fas fa-plus-circle more-maintenance-part-btn" ></i></a></h5>
                                                    </div>
                                                </div>
                                                <table class="table table-borderless">
                                                    <thead>
                                                        <tr>
                                                            <td style="width: 7%;">ลำดับที่</td>
                                                            <td style="width: 22%;">กลุ่มอะไหล่</td>
                                                            <td style="width: 22%;">ประเภทอะไหล่</td>
                                                            <td style="width: 22%;">ชนิดอะไหล่</td>
                                                            <td style="width: 22%;">อะไหล่</td>
                                                            <td style="width: 4%;"></td>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="add-more-part-table" id="add-more-part-table{{forloop.counter}}">
                                                        <!-- javascript table -->
                                                    </tbody>
                                                </table>
                                                <hr>
                                                <h5><u><strong>วิศวกรที่รับผิดชอบ</strong></u>
                                                <div class="form-group row" style="margin-top: 10px; padding-bottom: 0px;">
                                                    <div class="col-sm-6">
                                                        <label>ค้นหาด้วยรหัสพนักงาน :</label>
                                                        <select  class="selectpicker" data-live-search="true" id="engineer_user{{forloop.counter}}" name="engineer_username" onchange="load_selected_engineer(this)" required="True" data-url="{% url 'load_username' %}">
                                                            <option value="">-- กรุณาเลือกผู้ตรวจสอบ --</option>
                                                            {% for user in line_of_user %}
                                                            <option value="{{user.pk}}">{{user.pk}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label>ค้นหาด้วยชื่อพนักงาน :</label>
                                                        <select  class="selectpicker" data-live-search="true" id="engineer_name{{forloop.counter}}" name="engineer_name" onchange="load_selected_engineer(this)" required="True" data-url="{% url 'load_username' %}" >
                                                            <option value="">-- กรุณาเลือกผู้ตรวจสอบ --</option>
                                                            {% for user in line_of_user %}
                                                            <option value="{{user.pk}}">{{user.firstname}}  {{user.lastname}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control" name="engineer" id="set_engineer{{forloop.counter}}" value="" readonly/>

                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary" name="mtn_submit" value="{{repair.pk}}">Submit</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                        <!-- For loop jobs -->
                        {% for mtn_job in maintenance_job_gen %}
                            {% if mtn_job.job_status == "รอการมอบหมาย" %}
                            <div class="card">
                                <div class="card-hearder request-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-2"><b>{{mtn_job.job_no}}</b></h6>
                                        </div>
                                        <div class="text-right">
                                            <i class="fas fa-ellipsis-h" data-toggle="modal" data-target="#round-setting{{forloop.counter}}"></i>
                                        </div>
                                </div>
                                <div class="card-body">
                                    <p class="text-sm text-muted">{{mtn_job.job_mch_sp.spare_part}}</p>
                                    <p class="text-sm text-muted">{{mtn_job.job_mch_sp.machine.machine_name}} {{mtn_job.job_mch_sp.machine.line}}</p>
                                    <span>
                                        <i class="far fa-clock"></i> {{mtn_job.job_gen_date}}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                            <!-- Modal jobs -->
                            <div id="round-setting{{forloop.counter}}" class="modal fade" tabindex="-1">
                                <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <form method="POST">
                                            {% csrf_token %}
                                            <div class="modal-header">
                                                <h5 class="modal-title">Machine Maintenance Data</h5>
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <div class="form-row">
                                                        <div class="col-md-2">
                                                            <label>Line</label>
                                                            <input type="text" id="line_machine{{forloop.counter}}" class="form-control" name="line_machine" value="{{mtn_job.job_mch_sp.machine.line}}" readonly>
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label>Machine</label>
                                                            <input type="text" id="set_machine{{forloop.counter}}" class="form-control" name="set_machine" value="{{mtn_job.job_mch_sp.machine.machine_production_line_code}} | {{mtn_job.job_mch_sp.machine.machine_name}}" readonly>
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label>Spare Part</label>
                                                            <input type="text" id="set_spare_part{{forloop.counter}}" class="form-control" name="set_spare_part" value="{{mtn_job.job_mch_sp.spare_part.spare_part_group}} | {{mtn_job.job_mch_sp.spare_part}}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <label><strong>การซ่อมบำรุงรักษา</strong></label><hr>
                                                <div class="row">
                                                    <div class="form-group col-4">
                                                        <label>Last Maintenance</label>
                                                        <input type="number" class="form-control" id="last_mtn_change{{forloop.counter}}" name="last_mtn_change" value="{{mtn_job.job_mch_sp.last_mtnchng_hour}}">
                                                    </div>
                                                    <div class="form-group col-4">
                                                        <label>Life Maintenance</label>
                                                        <input type="number" class="form-control" id="life_mtn_hour{{forloop.counter}}" name="life_mtn_hour" value="{{mtn_job.job_mch_sp.mtnchng_life_hour}}">
                                                    </div>
                                                    <div class="form-group col-4">
                                                        <label>Next Maintenance</label>
                                                        <input type="number" class="form-control" id="next_mtn_change{{forloop.counter}}" name="next_mtn_change" value="{{mtn_job.job_mch_sp.next_mtnchng_hour}}">
                                                    </div>
                                                </div>

                                                <label><strong>การตรวจสอบ</strong></label><hr>
                                                <div class="row">
                                                    <div class="form-group col-4">
                                                        <label>Last Checking</label>
                                                        <input type="number" class="form-control" id="last_mtn_check{{forloop.counter}}" name="last_mtn_check" value="{{mtn_job.job_mch_sp.last_mtnchk_hour}}">
                                                    </div>
                                                    <div class="form-group col-4">
                                                        <label>Life Checking</label>
                                                        <input type="number" class="form-control" id="life_check_hour{{forloop.counter}}" name="life_check_hour" value="{{mtn_job.job_mch_sp.mtnchk_life_hour}}">
                                                    </div>
                                                    <div class="form-group col-4">
                                                        <label>Next Checking</label>
                                                        <input type="number" class="form-control" id="next_mtn_check{{forloop.counter}}" name="next_mtn_check" value="{{mtn_job.job_mch_sp.next_mtnchk_hour}}">
                                                    </div>
                                                </div>
                                                <hr>
                                                <h5><u><strong>วิศวกรที่รับผิดชอบ</strong></u>
                                                <div class="form-group row" style="margin-top: 10px; padding-bottom: 0px;">
                                                    <div class="col-sm-6">
                                                        <label>ค้นหาด้วยรหัสพนักงาน :</label>
                                                        <select  class="selectpicker" data-live-search="true" id="round_engineer_user{{forloop.counter}}" name="engineer_username" onchange="load_selected_engineer_round(this)" required="True" data-url="{% url 'load_round_username' %}">
                                                            <option value="">-- กรุณาเลือกผู้ตรวจสอบ --</option>
                                                            {% for user in line_of_user %}
                                                            <option value="{{user.pk}}">{{user.pk}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label>ค้นหาด้วยชื่อพนักงาน :</label>
                                                        <select  class="selectpicker" data-live-search="true" id="round_engineer_name{{forloop.counter}}" name="engineer_name" onchange="load_selected_engineer_round(this)" required="True" data-url="{% url 'load_round_username' %}">
                                                            <option value="">-- กรุณาเลือกผู้ตรวจสอบ --</option>
                                                            {% for user in line_of_user %}
                                                            <option value="{{user.pk}}">{{user.firstname}}  {{user.lastname}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <input type="text" class="form-control" name="engineer" id="set_round_engineer{{forloop.counter}}" value="" readonly/>

                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary" name="set_maintenance_data" value="{{mtn_job.job_mch_sp.pk}}">Submit</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                    </div>
                </div>
                <div class="col-lg-4 px-3">                  
                    <span class="h5">In progress</span>
                    <div class="scroll-area" data-spy="scroll" data-offset="0">
                        <!-- For loop maintenance requests -->
                        {% for mtn_job in maintenance_job_gen %}
                        {% if mtn_job.job_no|first in 'RP' and mtn_job.job_status == 'รอการดำเนินงาน' %}
                        <div class="card">
                            <div class="card-hearder request-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2"><b>{{mtn_job.job_no}}</b></h6>
                                    </div>
                                    <div class="text-right">
                                        <i class="fas fa-ellipsis-h" data-toggle="modal" data-target="#job{{forloop.counter}}"></i>
                                    </div>
                            </div>
                            <div class="card-body request">
                                {% if mtn_job.repair_notice_set %}
                                {% for repair in mtn_job.repair_notice_set.all %}
                                <span class="badge request-badge">{{repair.repair_no}}</span>
                                {% endfor %}
                                {% endif %}
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.spare_part.spare_part_name}}</p>
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.machine.machine_name}} {{mtn_job.job_mch_sp.machine.line}}</p>
                                <span>
                                    <i class="fas fa-hard-hat"></i>&nbsp;ENGINEER : {{mtn_job.job_response_user_id}}
                                </span>
                            </div>
                        </div>
                        <!-- For loop jobs -->
                        {% elif mtn_job.job_status == 'รอการดำเนินงาน' %}
                        <div class="card">
                            <div class="card-hearder request-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2"><b>{{mtn_job.job_no}}</b></h6>
                                    </div>
                                    <div class="text-right">
                                        <i class="fas fa-ellipsis-h" data-toggle="modal" data-target="#job{{forloop.counter}}"></i>
                                    </div>
                            </div>
                            <div class="card-body">
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.spare_part.spare_part_name}}</p>
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.machine.machine_name}} {{mtn_job.job_mch_sp.machine.line}}</p>
                                <span>
                                    <i class="fas fa-hard-hat"></i>&nbsp;ENGINEER : {{mtn_job.job_response_user_id}}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        <!-- Modal jobs -->
                        <div id="job{{forloop.counter}}" class="modal fade" tabindex="-1">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <form method="POST">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <h5 class="modal-title">Maintenance Report</h5>
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                        </div>
                                        <div class="modal-body">
                                            {% if mtn_job.repair_notice_set %}
                                            {% for repair in mtn_job.repair_notice_set.all %}
                                            <center><h5><u><strong>ข้อมูลใบแจ้งซ่อม</strong></u></h5></center><br>
                                            <div class="form-group row">
                                                <div class="col-5">
                                                    <label>หมายเลขใบแจ้งซ่อมเครื่องจักร</label>
                                                    <input type="text" class="form-control" value="{{repair.repair_no}}" readonly>
                                                </div>
                                                <div class="col-2">
                                                    <label>วันที่แจ้งซ่อมเครื่องจักร</label>
                                                    <input type="text" class="form-control" value="{{repair.notification_date}}" readonly>
                                                </div>
                                                <div class="col-2">
                                                    <label>วันที่ต้องการใช้งาน</label>
                                                    <input type="text" class="form-control" value="{{repair.use_date}}" readonly>
                                                </div>
                                                <div class="col-3">
                                                    <label>สถานะใบแจ้งซ่อมเครื่องจักร</label>
                                                    <input type="text" class="form-control" name="repair_no" value="{{repair.repair_status}}" readonly>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <label>ผู้แจ้งใบแจ้งซ่อมเครื่องจักร</label>
                                                    <input type="text" class="form-control" value="{{repair.repairer_user.username}}" readonly>
                                                </div>
                                                <div class="col-6">
                                                    <label>หน่วยงานที่แจ้งซ่อมเครื่องจักร</label>
                                                    <input type="text" class="form-control" value="{{repair.department_notifying.department_code}} {{repair.department_notifying.department_name}}" readonly>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="col-6">
                                                    <label>ปัญหาเครื่องจักรที่พบ</label>
                                                    <input type="text" class="form-control" value="{{repair.problem_report}}" readonly>
                                                </div>
                                                <div class="col-6">
                                                    <label>ผลกระทบของปัญหาเครื่องจักร</label>
                                                    <input type="text" class="form-control" value="{{repair.effect_problem}}" readonly>
                                                </div>
                                            </div>
                                            <hr>
                                            {% endfor %}
                                            {% endif %}
                                            <center><h5><u><strong>ข้อมูลงาน</strong></u></h5></center><br>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-6">
                                                        <label>หมายเลขงาน</label>
                                                        <input type="text" id="jobNo{{forloop.counter}}" class="form-control" name="job_no" value="{{mtn_job.job_no}}" readonly>
                                                    </div>
                                                    <div class="col-3">
                                                        <label>วันที่สร้างงาน</label>
                                                        <input type="text" id="job_gen_date{{forloop.counter}}" class="form-control" name="job_gen_date" value="{{mtn_job.job_gen_date}}" readonly>
                                                    </div>
                                                    <div class="col-3">
                                                        <label>สถานะงาน</label>
                                                        <input type="text" id="job_status{{forloop.counter}}" class="form-control" name="job_status" value="{{mtn_job.job_status}}" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-6">
                                                        <label>ผู้มอบหมายงาน</label>
                                                        <input type="text" id="job_assign{{forloop.counter}}" class="form-control" name="job_no" value="{{mtn_job.job_assign_user_id}}" readonly>
                                                    </div>
                                                    <div class="col-6">
                                                        <label>ผู้รับผิดชอบงาน</label>
                                                        <input type="text" id="job_response{{forloop.counter}}" class="form-control" name="job_gen_date" value="{{mtn_job.job_response_user_id}}" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            <h1>{{mtn_job.repair_notice_set.0.problem_report}}</h1>
                                            <hr><br>
                                            <center><h5><u><strong>ข้อมูลเครื่องจักร</strong></u></h5></center><br>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-md-2">
                                                        <label class="control-label">Line</label>
                                                        <input type="text" id="mch_line{{forloop.counter}}" class="form-control" name="mch_line" value="{{mtn_job.job_mch_sp.machine.line}}" readonly>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="control-label">Machine</label>
                                                        <input type="text" id="machine{{forloop.counter}}" class="form-control" name="machine" value="{{mtn_job.job_mch_sp.machine.machine_production_line_code}} | {{mtn_job.job_mch_sp.machine.machine_name}}" readonly>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="control-label">Spare Part</label>
                                                        <input type="text" id="spare_part{{forloop.counter}}" class="form-control" name="spare_part" value="{{mtn_job.job_mch_sp.spare_part.spare_part_group}} | {{mtn_job.job_mch_sp.spare_part}}" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr><br>
                                            <center><h5><u><strong>บันทึกผู้ดำเนินการซ่อม</strong></u></h5></center><br>
                                            <div class="form-group">
                                                <label>สาเหตุขัดข้องของเครื่อง</label>
                                                <textarea class="form-control" rows="2" name="problem_cause">{{mtn_job.problem_cause|default_if_none:''}}</textarea>
                                            </div>
                                            <div class="form-group">
                                                <label>วิธีดำเนินการแก้ไข</label>
                                                <textarea class="form-control" rows="2" name="corrective_action">{{mtn_job.corrective_action|default_if_none:''}}</textarea>
                                            </div>
                                            <div class="form-group">
                                                <label>วิธีการทำความสะอาดหลังการซ่อม</label>
                                                <textarea class="form-control" rows="2" name="after_repair">{{mtn_job.after_repair|default_if_none:''}}</textarea>
                                            </div>
                                            <hr size="6"><br>
                                            <center><h5><u><strong>รายการอุปกรณ์ / ชิ้นส่วนในการซ่อม</strong></u></h5></center><br>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-1">
                                                        <label>ลำดับที่</label><br>
                                                        <label class="col-sm-2 col-form-label">1</label><br>
                                                        <label class="col-sm-2 col-form-label">2</label><br>
                                                        <label class="col-sm-2 col-form-label">3</label>
                                                    </div>
                                                    <div class="col-2">
                                                        <label>รหัสอุปกรณ์</label>
                                                        <input type="text" id="equipment_code{{forloop.counter}}" class="form-control" name="equipment_code1" value="{{mtn_job.equipment_code1|default_if_none:''}}">
                                                        <input type="text" id="equipment_code2{{forloop.counter}}" class="form-control" name="equipment_code2" value="{{mtn_job.equipment_code2|default_if_none:''}}">
                                                        <input type="text" id="equipment_code3{{forloop.counter}}" class="form-control" name="equipment_code3" value="{{mtn_job.equipment_code3|default_if_none:''}}">
                                                    </div>
                                                    <div class="col-4">
                                                        <label>อุปกรณ์ที่ใช้ / รุ่น</label>
                                                        <input type="text" id="equipment_detail1{{forloop.counter}}" class="form-control" name="equipment_detail1" value="{{mtn_job.equipment_detail1|default_if_none:''}}">
                                                        <input type="text" id="equipment_detail2{{forloop.counter}}" class="form-control" name="equipment_detail2" value="{{mtn_job.equipment_detail2|default_if_none:''}}">
                                                        <input type="text" id="equipment_detail3{{forloop.counter}}" class="form-control" name="equipment_detail3" value="{{mtn_job.equipment_detail3|default_if_none:''}}">
                                                    </div>
                                                    <div class="col-2">
                                                        <label>จำนวน</label>
                                                        <input type="text" id="equipment_quantity1{{forloop.counter}}" class="form-control" name="equipment_quantity1" value="{{mtn_job.equipment_quantity1|default_if_none:''}}">
                                                        <input type="text" id="equipment_quantity2{{forloop.counter}}" class="form-control" name="equipment_quantity2" value="{{mtn_job.equipment_quantity2|default_if_none:''}}">
                                                        <input type="text" id="equipment_quantity3{{forloop.counter}}" class="form-control" name="equipment_quantity3" value="{{mtn_job.equipment_quantity3|default_if_none:''}}">
                                                    </div>
                                                    <div class="col-3">
                                                        <label>หมายเหตุ</label>
                                                        <input type="text" id="equipment_note1{{forloop.counter}}" class="form-control" name="equipment_note1" value="{{mtn_job.equipment_note1|default_if_none:''}}">
                                                        <input type="text" id="equipment_note2{{forloop.counter}}" class="form-control" name="equipment_note2" value="{{mtn_job.equipment_note2|default_if_none:''}}">
                                                        <input type="text" id="equipment_note3{{forloop.counter}}" class="form-control" name="equipment_note3" value="{{mtn_job.equipment_note3|default_if_none:''}}">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-4">
                                                        <label>ค่าใช้จ่ายโดยประมาณ</label>
                                                        <input type="number" class="form-control" id="estimate_cost" name="estimate_cost" value="{{mtn_job.estimate_cost|default_if_none:''}}">
                                                    </div>
                                                    <div class="col-8">
                                                        <label>หมายเหตุ</label>
                                                        <input type="text" class="form-control" id="job_remark" name="job_remark" value="{{mtn_job.job_remark|default_if_none:''}}">
                                                    </div>
                                                </div>
                                            </div>
                                            <hr><br>
                                            <center><h5><u><strong>ผลการดำเนินการ</strong></u></h5></center><br>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-md-4">
                                                        <label class="control-label">Maintenance Type</label>
                                                        <select class="form-control" id="mtn_type{{forloop.counter}}" name="mtn_type">
                                                            {% if mtn_job.job_mtn_type != "repair" %}
                                                            <option value="change" {% if mtn_job.job_mtn_type == 'change' %}selected{% endif %}>Change</option>
                                                            <option value="checking" {% if mtn_job.job_mtn_type == 'checking' %}selected{% endif %}>Checking</option>
                                                            {% else  %}
                                                            <option value="repair" selected>Repair</option>
                                                            {% endif %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <label class="control-label">Maintenance Result</label>
                                                        <select class="form-control" id="mtn_result{{forloop.counter}}" name="mtn_result">
                                                            <option value="good">Good</option>
                                                            <option value="fair">Fair</option>
                                                            <option value="poor">Poor</option>
                                                            <option value="maintenance">Maintenance</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>Maintenance Result Description</label>
                                                <input type="text" id="mtn_result_description{{forloop.counter}}" class="form-control" name="mtn_result_description" value="{{mtn_job.job_result_description|default_if_none:''}}">
                                            </div>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <label>Machine Hour</label>
                                                        <input type="number" id="machine_hour_pv{{forloop.counter}}" class="form-control" name="machine_hour_pv" value="{{mtn_job.job_mch_sp.machine.machine_hour}}" readonly>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Machine Hour Manual</label>
                                                        <input type="number" id="machine_hour_sp{{forloop.counter}}" class="form-control" name="machine_hour_sp" placeholder="เปลี่ยนชั่วโมงเครื่องจักร">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <label>Change Life Hour</label>
                                                        <input type="number" id="chang_life_hour_pv{{forloop.counter}}" class="form-control" name="chang_life_hour_pv" value="{{mtn_job.job_mch_sp.mtnchng_life_hour}}" readonly >
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Change Life Hour Manual</label>
                                                        <input type="number" id="chang_life_hour_sp{{forloop.counter}}" class="form-control" name="chang_life_hour_sp" placeholder="เปลี่ยนชั่วโมงการเปลี่ยนอะไหล่">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="form-row">
                                                    <div class="col-md-6">
                                                        <label>Check Life Hour</label>
                                                        <input type="number" id="check_life_hour_pv{{forloop.counter}}" class="form-control" name="check_life_hour_pv" value="{{mtn_job.job_mch_sp.mtnchk_life_hour}}" readonly >
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Check Life Hour Manual</label>
                                                        <input type="number" id="check_life_hour_sp{{forloop.counter}}" class="form-control" name="check_life_hour_sp" placeholder="เปลี่ยนชั่วโมงการตรวจสอบอะไหล่">
                                                    </div>
                                                </div>
                                            </div>
                                            <small>Assign By {{mtn_job.job_assign_user_id}} [ {{mtn_job.job_assign_date}} ]</small><br>
                                            <small>Response By {{mtn_job.job_response_user_id}} [ {{mtn_job.job_report_date}} ]</small><br>
                                            <small>Approve By {{mtn_job.job_assign_user_id}} [ {{mtn_job.job_approve_date}} ]</small>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary" name="report_submit" value="{{mtn_job.pk}}">Submit</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        {% endfor %}
                    </div>
                </div>
                <div class="col-lg-4 px-3">
                    <span class="h5">Completed</span>
                    <div class="scroll-area" data-spy="scroll" data-offset="0">
                        <!-- For loop maintenance requests -->
                        {% for mtn_job in maintenance_job_gen %}
                        {% if mtn_job.job_no|first in 'RP' and mtn_job.job_status == 'รอการอนุมัติงาน' %}
                        <div class="card">
                            <div class="card-hearder request-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2"><b>{{mtn_job.job_no}}</b></h6>
                                    </div>
                                    <div class="text-right">
                                        <i class="fas fa-ellipsis-h" data-toggle="modal" data-target="#complete{{forloop.counter}}"></i>
                                    </div>
                            </div>
                            <div class="card-body request">
                                {% if mtn_job.repair_notice_set %}
                                {% for repair in mtn_job.repair_notice_set.all %}
                                <span class="badge request-badge">{{repair.repair_no}}</span>
                                {% endfor %}
                                {% endif %}
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.spare_part}}</p>
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.machine.machine_name}} {{mtn_job.job_mch_sp.machine.line}}</p>
                                <span>
                                    <i class="fas fa-hard-hat"></i>&nbsp;ENGINEER : {{mtn_job.job_response_user_id}}<br>
                                    <i class="far fa-clock"></i> FINISHED : {{mtn_job.job_report_date}}
                                </span>
                            </div>
                        </div>
                        {% elif mtn_job.job_status == 'รอการอนุมัติงาน' %}
                        <div class="card">
                            <div class="card-hearder request-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2"><b>{{mtn_job.job_no}}</b></h6>
                                    </div>
                                    <div class="text-right">
                                        <i class="fas fa-ellipsis-h" data-toggle="modal" data-target="#complete{{forloop.counter}}"></i>
                                    </div>
                            </div>
                            <div class="card-body">
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.spare_part}}</p>
                                <p class="text-sm text-muted">{{mtn_job.job_mch_sp.machine.machine_name}} {{mtn_job.job_mch_sp.machine.line}}</p>
                                <span>
                                    <i class="fas fa-hard-hat"></i>&nbsp;ENGINEER : {{mtn_job.job_response_user_id}}<br>
                                    <i class="far fa-clock"></i> FINISHED : {{mtn_job.job_report_date}}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                        <!-- Modal Completed Jobs  -->
                        <div id="complete{{forloop.counter}}" class="modal fade" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <form method="POST">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <h5 class="modal-title">รายงานระบบซ่อมบำรุง</h5>
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                        </div>
                                        <div class="modal-body">
                                            <label><u><strong>ข้อมูลงาน</strong></u></label><br>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="control-label">หมายเลขงาน : {{mtn_job.job_no}}</label><br>
                                                    <label class="control-label">ผู้มอบหมายงาน : {{mtn_job.job_assign_user_id}}</label><br>
                                                    <label class="control-label">ผู้รับผิดชอบงาน : {{mtn_job.job_response_user_id}}</label><br>
                                                    <label class="control-label">สถานะงาน : <u>{{mtn_job.job_status}}</u></label><br>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="control-label">วันที่สร้างงาน : {{mtn_job.job_gen_date}}</label><br>
                                                    <label class="control-label">วันที่มอบหมายงาน : {{mtn_job.job_assign_date}}</label><br>
                                                    <label class="control-label">วันที่รายงานผลของงาน : {{mtn_job.job_report_date|default_if_none:''}}</label><br>
                                                    <label class="control-label">วันที่อนุมัติงาน : {{mtn_job.job_approve_date|default_if_none:''}}</label><br>
                                                </div>
                                            </div>
                                            <hr>
                                            <label><u><strong>เครื่องจักรและอะไหล่ที่บำรุงรักษา</strong></u></label><br>
                                            <label class="control-label">Production Line : {{mtn_job.job_mch_sp.machine.line.production_line}}</label><br>
                                            <label class="control-label">Machine : {{mtn_job.job_mch_sp.machine.machine_production_line_code}} | {{mtn_job.job_mch_sp.machine.machine_name}}</label><br>
                                            <label class="control-label">Spare Part : {{mtn_job.job_mch_sp.spare_part.spare_part_group}} | {{mtn_job.job_mch_sp.spare_part}}</label><br>
                                            <hr>
                                            <label><u><strong>ข้อมูลงานและปัญหา</strong></u></label><br>
                                            <label class="control-label">สาเหตุขัดข้องของเครื่อง : {{mtn_job.problem_cause}}</label><br>
                                            <label class="control-label">วิธีดำเนินการแก้ไข : {{mtn_job.corrective_action}}</label><br>
                                            <label class="control-label">วิธีการทำความสะอาดหลังการซ่อม : {{mtn_job.after_repair}}</label><br>
                                            <hr>
                                            <label><u><strong>รายการอุปกรณ์ / ชิ้นส่วนในการซ่อม</strong></u></label><br>
                                            {% if not mtn_job.equipment_code1 and not mtn_job.equipment_code2 and not mtn_job.equipment_code3 %}
                                            <label class="control-label">ไม่มีอุปกรณ์ที่ใช้</label><br>
                                            <label class="control-label">ค่าใช้จ่ายโดยประมาณ : <u>ไม่มี</u></label>
                                            {% else %}
                                            {% if mtn_job.equipment_code1 %} <label class="control-label">1. รหัสอุปกรณ์ {{mtn_job.equipment_code1}}   {{mtn_job.equipment_detail1}} จำนวน {{mtn_job.equipment_quantity1}} {% if tmn_job.equipment_note1 %} หมายเหตุ {{tmn_job.equipment_note1}} {% endif %}</label><br> {% endif %}
                                            {% if mtn_job.equipment_code2 %} <label class="control-label">2. รหัสอุปกรณ์ {{mtn_job.equipment_code2}}   {{mtn_job.equipment_detail2}} จำนวน {{mtn_job.equipment_quantity2}} {% if tmn_job.equipment_note2 %} หมายเหตุ {{tmn_job.equipment_note2}} {% endif %}</label><br> {% endif %}
                                            {% if mtn_job.equipment_code3 %} <label class="control-label">3. รหัสอุปกรณ์ {{mtn_job.equipment_code3}}   {{mtn_job.equipment_detail3}} จำนวน {{mtn_job.equipment_quantity3}} {% if tmn_job.equipment_note3 %} หมายเหตุ {{tmn_job.equipment_note3}} {% endif %}</label><br> {% endif %}
                                            <label class="control-label">ค่าใช้จ่ายโดยประมาณ : <u>{{mtn_job.estimate_cost|default_if_none:'ไม่เสียค่าใช้จ่าย'}}</u> {% if mtn_job.estimate_cost %}บาท{% endif %}</label><br>
                                            <label class="control-label">หมายเหตุ : {{mtn_job.job_remark}}</label>
                                            {% endif %}
                                            <hr>
                                            <label><u><strong>ข้อมูลการซ่อมบำรุงรักษา</strong></u></label><br>
                                            <label class="control-label">ชนิดการซ่อมบำรุงรักษา : {{mtn_job.job_mtn_type|default_if_none:''}}</label><br>
                                            <label class="control-label">ผลการซ่อมบำรุง/ตรวจสอบ : {{mtn_job.job_result_type|default_if_none:''}}</label><br>
                                            <label class="control-label">รายละเอียดเพิ่มเติม : {{mtn_job.job_result_description|default_if_none:''}}</label><br>
                                            <label class="control-label">ชั่วโมงเครื่องจักรที่บันทึกผล : {{mtn_job.job_mch_hour|default_if_none:''}}</label><br>
                                            <label class="control-label">อายุการใช้การเปลี่ยนของอะไหล่ที่บันทึกผล : {{mtn_job.job_fix_plan_hour|default_if_none:''}}</label><br>
                                            <label class="control-label">อายุการใช้การตรวจสอบของอะไหล่ที่บันทึกผล : {{mtn_job.job_plan_hour|default_if_none:''}}</label><br>
                                            <hr>
                                            <label><u><strong>การอนุมัติงาน</strong></u></label><br>
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label class="control-label">การอนุมัติงานหรือไม่ : </label><br>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="onoffswitch">
                                                        <input type="checkbox" class="onoffswitch-checkbox" id="is_approve{{forloop.counter}}" name="is_approve" value="True" {% if mtn_job.is_approve %}checked{% endif %}>
                                                        <label class="onoffswitch-label" for="is_approve{{forloop.counter}}">
                                                            <span class="onoffswitch-inner"></span>
                                                            <span class="onoffswitch-switch"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary" name="approve_job" value="{{mtn_job.pk}}" {% if mtn_job.is_approve  %}disabled{% endif %}>Approve</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal Unaccepted Maintenance Request -->
        <div class="modal fade" id="unacceptedMR" tabindex="-1">
            <div class="modal-dialog modal-xl modal-request">
                <div class="modal-content">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title">ใบแจ้งซ่อมเครื่องจักร</h5>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive" id="maintenance-request-table">
                                <table class="table table-striped maintenance-request-table">
                                    <thread>
                                        <tr>
                                            <th style="width: 2%">#</th>
                                            <th style="width: 10%">ใบแจ้งซ่อม</th>
                                            <th style="width: 23%">หน่วยงานที่แจ้ง</th>
                                            <th style="width: 20%">เครื่องจักร</th>
                                            <th style="width: 20%">ปัญหาที่พบ</th>
                                            <th style="width: 10%">วันที่ต้องการใช้</th>
                                            <th style="width: 15%"></th>
                                        </tr>
                                    </thread>
                                    <tbody>
                                        {% for repair in repair_receive_all %}
                                        <tr>
                                            <td>{{forloop.counter}}</td>
                                            <td>{{repair.repair_no}}</td>
                                            <td>{{repair.department_notifying.department_name}} ({{repair.repairer_user.firstname}}  {{repair.repairer_user.lastname}})</td>
                                            <td>{{repair.machine.machine_production_line_code}} | {{repair.machine.machine_name}}</td>
                                            <td>{{repair.problem_report}}</td>
                                            <td>{{repair.use_date}}</td>
                                            <td>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="is_receive{{repair.repair_no}}" id="is_receive{{forloop.counter}}" value="is_receive" checked>
                                                    <label class="form-check-label" for="is_receive{{forloop.counter}}" >รับใบแจ้งซ่อมฯ</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="is_receive{{repair.repair_no}}" id="not_receive{{forloop.counter}}" value="not_receive" >
                                                    <label class="form-check-label" for="not_receive{{forloop.counter}}" >ไม่รับใบแจ้งซ่อมฯ</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="is_receive{{repair.repair_no}}" id="is_cancel{{forloop.counter}}" value="is_cancel" >
                                                    <label class="form-check-label" for="is_cancel{{forloop.counter}}">ยกเลิกใบแจ้งซ่อมฯ</label>
                                                </div>
                                            </td>
                                            
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" name="repair_submit" value="{{repair.pk}}">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}

<!-- Add more maintenance part -->
<script> 
        // Append table with add row form on add new button click
        var rowIdx = 0;
        var rowDict = {};
        function morePart(element){
            var table = element.id;
            var rowKey = element.id.substr(9);
            var num_loop = element.id.substr(9);
            if (rowDict[rowKey]) {
                rowValue = rowDict[rowKey]
                rowDict[rowKey] = ++rowValue;

            } else {
                rowDict[rowKey] = 1;
            }
            
            // console.log(rowDict);
            rowIdx = rowDict[rowKey];
            //console.log(rowDict);
            $(`#add-more-part-table${num_loop}`).append(`<tr id="R${rowIdx}">
                <td class="row-index">${rowIdx}</td>
                <td>
                    <select class="form-control" id="select_sp_group${rowIdx}_${table}" name="select_sp_group" onchange="ajax_dropdown_type(this)" data-url="{% url 'ajax_dropdown_sp_type' %}">
                        <option value="0">เลือกกลุ่มอะไหล่</option>
                        {% for sp_group in spare_part_group_all %}
                        <option value="{{sp_group.pk}}" {% if repair.spare_part_1.spare_part_group_id == sp_group.pk %}selected{% endif %}>{{sp_group.spare_part_group_code}} | {{sp_group.spare_part_group_name}}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select class="form-control" id="select_sp_type${rowIdx}_${table}" name="select_sp_type" required="True" onchange="ajax_dropdown_subtype(this)" data-url="{% url 'ajax_dropdown_sp_subtype' %}" >
                        <option value="0">เลือกประเภทอะไหล่</option>
                        {% if repair.spare_part_1_id %}
                        <option value="{{repair.spare_part_1.spare_part_type_id}}" selected>{{repair.spare_part_1.spare_part_type.spare_part_type_code}} | {{repair.spare_part_1.spare_part_type.spare_part_type_name}}</option>
                        {% endif %}
                    </select>
                </td>
                <td>
                    <select class="form-control" id="select_sp_subtype${rowIdx}_${table}" name="select_sp_subtype" required="True" onchange="ajax_dropdown_sp(this)" data-url="{% url 'ajax_dropdown_sp' %}" >
                        <option value="0">เลือกชนิดอะไหล่</option>
                        {% if repair.spare_part_1_id %}
                        <option value="{{repair.spare_part_1.spare_part_type_id}}" selected>{{repair.spare_part_1.spare_part_sub_type.spare_part_sub_type_code}} | {{repair.spare_part_1.spare_part_sub_type.spare_part_sub_type_name}}</option>
                        {% endif %}
                    </select>
                </td>
                <td>
                    <select class="form-control" id="select_sp_name${rowIdx}_${table}" name="select_sp_name1" required="True"  >
                        <option value="0">เลือกอะไหล่</option>
                        {% if repair.spare_part_1_id %}<option value="{{repair.spare_part_1_id}}" selected>{{repair.spare_part_1.spare_part_name}}</option>{% endif %}
                    </select>
                </td>
                <td>
                    <a class="delete" id="delete${rowIdx}" title="Delete" data-toggle="tooltip"><i class="material-icons">&#xE872;</i></a>
                </td>
            </tr>`);

            $(`#delete${rowIdx}`).click(function(){ 
                var tableID =  $(`#add-more-part-table${num_loop}`).attr('id');
                //console.log(tableID);
                var removerowKey = tableID.substr(19);
                var removeValue = rowDict[removerowKey]
                rowDict[removerowKey] = --removeValue; 
                //console.log(rowDict);
            });
            // Delete row on delete button click 
            $(`#add-more-part-table${num_loop}`).on("click", ".delete", function(){  
                
                // Getting all the rows next to the row 
                // containing the clicked button 
                var child = $(this).closest('tr').nextAll(); 

                // Iterating across all the rows 
                // obtained to change the index 
                child.each(function () { 

                // Getting <tr> id. 
                var id = $(this).attr('id'); 
                //console.log('<tr> id'+id);

                // Getting the <p> inside the .row-index class. 
                var idx = $(this).children('.row-index'); 

                // Gets the row number from <tr> id. 
                var dig = parseInt(id.substring(1)); 

                // Modifying row index. 
                idx.html(`${dig - 1}`); 

                // Modifying row id. 
                $(this).attr('id', `R${dig - 1}`); 
                }); 

                // Removing the current row. 
                $(this).closest('tr').remove(); 

            }); 
            
        };
        
</script> 
<script src="{% static 'javascript/input_date.js'%}"></script>
<!-- Machine Ajax -->
<script>
    function ajax_dropdown_type(element) {
        var filter_sp_type = $(element).val();
        var numID = element.id.substr(17);
        var indexID = element.id.substr(15,2);
        $.ajax({
            url : $(element).attr("data-url"),
            data : {
                "csrfmiddlewaretoken" : $(element).siblings("input[name='csrfmiddlewaretoken']" ).val(),
                "filter_sp_type" : filter_sp_type,

            },
            method: "POST",
            dataType : "json",
            success : function (data) {
                if (data) {
                    $('#select_sp_type'+indexID+numID).empty();
                    var select_type = document.getElementById('select_sp_type'+indexID+numID);
                    var option_first = document.createElement('option');
                    option_first.appendChild(document.createTextNode("เลือกประเภทอะไหล่"));
                    option_first.value = 0;
                    select_type.appendChild(option_first);
                    for (model in data) {
                        var options = document.createElement('option');
                        var code = data[model].fields.spare_part_type_code;
                        var name = data[model].fields.spare_part_type_name;
                        options.appendChild(document.createTextNode(code+" | "+name));
                        options.value = data[model].pk;
                        select_type.appendChild(options);
                    }
                } else {
                    $('#select_sp_type'+indexID+numID).empty();
                }
            }
        });
    }
</script>
<script>
    function ajax_dropdown_subtype(element) {
        var filter_sp_subtype = $(element).val();
        var numID = element.id.substr(16);
        var indexID = element.id.substr(14,2);
        $.ajax({
            url : $(element).attr("data-url"),
            data : {
                "csrfmiddlewaretoken" : $(element).siblings("input[name='csrfmiddlewaretoken']" ).val(),
                "filter_sp_subtype" : filter_sp_subtype,

            },
            method: "POST",
            dataType : "json",
            success : function (data) {
                if (data) {
                    $('#select_sp_subtype'+indexID+numID).empty();
                    var select_subtype = document.getElementById('select_sp_subtype'+indexID+numID);
                    var option_first_subtype = document.createElement('option');
                    option_first_subtype.appendChild(document.createTextNode("เลือกชนิดอะไหล่"));
                    option_first_subtype.value = 0;
                    select_subtype.appendChild(option_first_subtype);
                    for (model in data) {
                        var options = document.createElement('option');
                        var code = data[model].fields.spare_part_sub_type_code;
                        var name = data[model].fields.spare_part_sub_type_name;
                        options.appendChild(document.createTextNode(code+" | "+name));
                        options.value = data[model].pk;
                        select_subtype.appendChild(options);
                    }
                } else {
                    $('#select_sp_subtype'+indexID+numID).empty();
                }
            }
        });
    }
</script>
<script>
    function ajax_dropdown_sp(element) {
        var filter_sp = $(element).val();
        var numID = element.id.substr(19);
        var indexID = element.id.substr(17,2);
        $.ajax({
            url : $(element).attr("data-url"),
            data : {
                "csrfmiddlewaretoken" : $(element).siblings("input[name='csrfmiddlewaretoken']" ).val(),
                "filter_sp" : filter_sp,

            },
            method: "POST",
            dataType : "json",
            success : function (data) {
                if (data) {
                    $('#select_sp_name'+indexID+numID).empty();
                    var select_sp = document.getElementById('select_sp_name'+indexID+numID);
                    var option_first_subtype = document.createElement('option');
                    option_first_subtype.appendChild(document.createTextNode("เลือกชนิดอะไหล่"));
                    option_first_subtype.value = 0;
                    select_sp.appendChild(option_first_subtype);
                    for (model in data) {
                        var options = document.createElement('option');
                        var name = data[model].fields.spare_part_name;
                        options.appendChild(document.createTextNode(name));
                        options.value = data[model].pk;
                        select_sp.appendChild(options);
                    }
                } else {
                    $('#select_sp_subtype'+indexID+numID).empty();
                }
            }
        });
    }
</script>
<!-- Function assign job to engineer -->
<script>
    // Requested maintenance
    function load_selected_engineer(element) {
            var username = $(element).val();
            var num_loop = element.id.substr(13);

            var engineer_username = document.getElementById('engineer_user'+num_loop);
            var engineer_name = document.getElementById('engineer_name'+num_loop);
            var set_engineer = document.getElementById('set_engineer'+num_loop);
            engineer_username.value = username;
            engineer_name.value = username;
            $('.selectpicker').selectpicker('refresh');
            
            $.ajax({
                url : $(element).attr("data-url"),
                data : {
                    "csrfmiddlewaretoken" : $(element).siblings("input[name='csrfmiddlewaretoken']" ).val(),
                    "username" : username,

                },
                method: "POST",
                dataType : "json",
                success : function (data) {
                    if (data.user_success) {
                        set_engineer.value = data.user_username+" - "+data.user_firstname+" "+data.user_lastname;
                    }
                }
            });
    }
    // Round maintenance
    function load_selected_engineer_round(element) {
            var round_engineer = $(element).val();
            var num_loop = element.id.substr(19);
            //console.log(round_engineer);
            //console.log(num_loop);
            var engineer_username = document.getElementById('round_engineer_user'+num_loop);
            var engineer_name = document.getElementById('round_engineer_name'+num_loop);
            var set_engineer = document.getElementById('set_round_engineer'+num_loop);
            engineer_username.value = round_engineer;
            engineer_name.value = round_engineer;
            $('.selectpicker').selectpicker('refresh');
            
            $.ajax({
                url : $(element).attr("data-url"),
                data : {
                    "csrfmiddlewaretoken" : $(element).siblings("input[name='csrfmiddlewaretoken']" ).val(),
                    "round_engineer" : round_engineer,

                },
                method: "POST",
                dataType : "json",
                success : function (data) {
                    if (data.round_success) {
                        set_engineer.value = data.round_username+" - "+data.round_firstname+" "+data.round_lastname;
                    }
                }
            });
    }
</script>
{% endblock %}
